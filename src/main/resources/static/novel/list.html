<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" charset="UTF-8" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>章节列表</title>
</head>
<style>
    .container {
        width: 100%;
    }

    .row-header {
        text-align: center;
        margin: 2% 0 1% 0;
    }

    .panel-title {
        display: inline-block;
    }

    .novel-name {
        display: inline-block;
    }

    .fuzzy-query {
        width: 130px;
        display: inline-block;
        margin-left: 5%;
        margin-bottom: -8px;
    }

    .fuzzy-query:hover {
        cursor: pointer;
    }
</style>
<body>
<div class="container">
    <div class="row clearfix">
        <div class="col-md-12 col-lg-12 column">
            <div>
                <h3 class="novel-name">名称</h3>
                <div class="fuzzy-query">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="章节名称" value=""/>
                        <span class="input-group-addon" onclick="search()"><span
                                class="glyphicon glyphicon-search"></span></span>
                    </div>
                </div>
                <a class="btn btn-primary btn-sm pull-right" href="../main.html"
                   style="margin-top: 16px;margin-bottom: 10px;">
                    <span class="glyphicon glyphicon-home"></span> 主页
                </a>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">章节列表</h4>
                    <button class="btn btn-success btn-xs pull-right" id="orderType" onclick="changeOrder()">
                        <span class="glyphicon glyphicon-sort"></span> 正序
                    </button>
                </div>
                <div class="panel-body">
                    <dl></dl>
                </div>
                <div class="panel-foot"></div>
            </div>
            <ul class="pagination">
                <li id="pageFirst"><a href="#">&laquo;</a></li>
                <li id="pagePrev"><a href="#">Prev</a></li>
                <li id="pageNext"><a href="#">Next</a></li>
                <li id="pageLast"><a href="#">&raquo;</a></li>
            </ul>
        </div>
    </div>
</div>
</body>
<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../js/common.js"></script>
<script>
    var novelCode = getUrlValue("novelCode");
    var dispOrder = getUrlValue("dispOrder");
    var pageSize = 30;
    var pageNo = 1;
    var orderType = 0;
    var keywords = $(".fuzzy-query").find("input").val();
    $(function () {

        if (dispOrder != null){
            pageNo =  Math.ceil(parseInt(dispOrder) / pageSize);
            orderType = 1;
            $("#orderType").html('<span class="glyphicon glyphicon-sort"></span> 倒序');
        }

        // 初始化
        getNovel(novelCode);
        getNovelChapterPage(pageNo, pageSize, orderType, keywords);

        // 监听上下页
        $("#pageFirst").click(function () {
            keywords = $(".fuzzy-query").find("input").val();
            getNovelChapterPage(pageNo, pageSize, orderType, keywords);
        });
        $("#pageLast").click(function () {
            pageNo = $("#pageNum").find("strong").text();
            keywords = $(".fuzzy-query").find("input").val();
            getNovelChapterPage(pageNo, pageSize, orderType, keywords);
        });
        $("#pagePrev").click(function () {
            pageNo = parseInt($(".pageNo.active").find("a").text());
            pageNo = pageNo > 1 ? pageNo - 1 : pageNo;
            keywords = $(".fuzzy-query").find("input").val();
            getNovelChapterPage(pageNo, pageSize, orderType, keywords);
        });
        $("#pageNext").click(function () {
            pageNo = parseInt($(".pageNo.active").find("a").text());
            var pageNum = $("#pageNum").find("strong").text();
            pageNo = pageNo < pageNum ? pageNo + 1 : pageNum;
            keywords = $(".fuzzy-query").find("input").val();
            getNovelChapterPage(pageNo, pageSize, orderType, keywords);
        });
    });

    function getNovel(novelCode) {
        $.ajax({
            url: "/api/novel/" + novelCode,
            type: "post",
            data: {},
            dataType: "json",
            success: function (data) {
                var content = data.data;
                $("h3").text(content.novelName);
            }
        })
    }

    function getNovelChapterPage(pageNo, pageSize, orderType, keywords) {
        $.ajax({
            url: "/api/novel/" + novelCode + "/page/" + pageNo,
            type: "post",
            dataType: "json",
            data: {
                pageSize: pageSize,
                orderType: orderType,
                keywords: keywords
            },
            success: function (data) {
                var page = data.data;
                var contentHtml = "";
                console.log(page);
                page.content.forEach(function (value) {
                    contentHtml += '<dd><a href="detail.html?id=' + value.id + '">' + value.chapterName + '</a></dd>';
                });
                $(".panel-body dl").html("");
                $(".panel-body dl").append(contentHtml);
                setPagination(pageNo, page.totalPages, 1);
            },
            error: function (XMLHttpRequest) {
                console.log(XMLHttpRequest);
                // location.href = "../login.html";
            }
        })
    }

    function setPagination(pageNo, pageNum, pageSpace) {
        $(".pageNo").remove();
        if (pageNo <= pageSpace) {
            $("#pagePrev").after(getPaginationHtml(1, pageSpace * 2 + 1));
        } else if (pageNo + pageSpace >= pageNum) {
            $("#pagePrev").after(getPaginationHtml(pageNum - pageSpace * 2, pageNum));
        } else {
            $("#pagePrev").after(getPaginationHtml(pageNo - pageSpace, pageNo + pageSpace));
        }
        $("#pageNext").before('<li id="pageNum" class="disabled"><a href="#">共<strong>' + pageNum + '</strong>页</a></li>');
        $("#pageNo" + pageNo).addClass("active");
    }

    function getPaginationHtml(pageBegin, pageEnd) {
        var paginationContent = "";
        for (var i = pageBegin; i <= pageEnd; i++) {
            paginationContent += '<li class="pageNo" id="pageNo' + i + '"><a href="#" onclick="getPage(' + i + ')">' + i + '</a></li>';
        }
        return paginationContent;
    }

    // 分页响应
    function getPage(pageNo) {
        getNovelChapterPage(pageNo, pageSize, orderType, keywords);
    }

    // 切换排序方式
    function changeOrder() {
        orderType = orderType ^ 1;
        $("#orderType").html('<span class="glyphicon glyphicon-sort"></span> ' + (orderType == 0 ? '正序' : '倒序'));
        pageNo = $(".pageNo.active").find("a").text();
        getNovelChapterPage(pageNo, pageSize, orderType, keywords);
    }

    // 模糊查询章节
    function search() {
        var keywords = $(".fuzzy-query").find("input").val();
        getNovelChapterPage(pageNo, pageSize, orderType, keywords);
    }
</script>
</html>